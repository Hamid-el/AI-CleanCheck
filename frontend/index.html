<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AI CleanCheck - Quality Assurance</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --wisag-green: #6db133;
            --wisag-dark: #3e3e40;
            --primary-color: #6db133;
            --primary-dark: #5a9429;
            --success-color: #6db133;
            --warning-color: #facc15; /* updated to distinct yellow */
            --danger-color: #ef4444;
            --dark: #3e3e40;
            --dark-light: #5a5a5c;
            --light: #f8f9fa;
            --white: #ffffff;
            --text-primary: #2c2c2e;
            --text-secondary: #8e8e93;
            --border-color: #e5e5ea;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: var(--text-primary);
            padding-bottom: 70px; /* reserve space for bottom nav */
            line-height: 1.6;
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 0;
        }

        /* Header */
        .header {
            background: var(--white);
            padding: 24px 28px;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
            padding-top: calc(24px + env(safe-area-inset-top)); /* respect iOS notch */
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 16px;
            min-width: 0;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            flex-shrink: 0;
        }

        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .logo-text h1 {
            font-size: 22px;
            font-weight: 600;
            color: var(--wisag-dark);
            letter-spacing: -0.5px;
            line-height: 1.2;
            white-space: nowrap;
        }

        .logo-text p {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 400;
            margin-top: 2px;
            line-height: 1.1;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--success-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-name {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .btn-logout {
            padding: 8px 16px;
            font-size: 13px;
            background: #f8f9fa;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-logout:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: var(--white);
            border-top: 1px solid var(--border-color);
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 200;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.08);
            /* Make the footer height account for safe-area and keep inner content 56px tall */
            height: calc(56px + env(safe-area-inset-bottom));
            padding-bottom: env(safe-area-inset-bottom);
            align-items: center; /* center items within the 56px content box */
            -webkit-tap-highlight-color: transparent;
            transform: translateZ(0); /* fix iOS hit-testing quirks on fixed elements */
        }

        .nav-tab {
            flex: 1;
            padding: 16px 20px;
            text-align: center;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            letter-spacing: -0.1px;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%; /* equals 56px via parent content-box */
            position: relative;
            z-index: 1;
            touch-action: manipulation; /* better mobile tap behavior */
        }

        .nav-tab.active {
            color: var(--wisag-green);
            border-bottom-color: var(--wisag-green);
            font-weight: 600;
        }

        .nav-tab:hover {
            background: #f8f9fa;
            color: var(--wisag-green);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 28px 20px 80px;
            animation: fadeIn 0.4s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: 16px;
            padding: 32px 28px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 24px;
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }

        /* Header with inline task selector */
        .card-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 12px;
        }

        .task-selector.inline {
            display: inline-flex;
            margin-bottom: 0;
        }

        .task-selector.inline .task-option {
            padding: 10px 12px;
            max-width: none;
        }

        /* Task Selector */
        /* Task Selector (refactored) */
        .task-selector {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        .task-option {
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--white);
            max-width: 220px;
        }

        .task-option:hover {
            border-color: var(--primary-color);
            background: #eff6ff;
        }

        .task-option.selected {
            border-color: var(--primary-color);
            background: #eff6ff;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .task-dropdown-wrapper {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 320px;
        }

        #manualTaskSelect {
            width: 100%;
            padding: 12px 14px;
            font-size: 14px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--white);
            cursor: pointer;
        }

        .task-option[style*="pointer-events: none"] {
            cursor: not-allowed;
            background: #f5f5f5;
            border-color: #d1d5db;
        }

        .task-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .task-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            letter-spacing: -0.1px;
        }

        .btn-primary {
            background: var(--wisag-green);
            color: var(--white);
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-success {
            background: var(--wisag-green);
            color: var(--white);
            box-shadow: var(--shadow-sm);
        }

        .btn-success:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: #e9ecef;
            border-color: #dee2e6;
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        /* Snake Loading Animation */
        .snake-loader-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            gap: 24px;
        }

        .snake-path {
            position: relative;
            width: 200px;
            height: 100px;
            margin: 0 auto;
        }

        .snake-head {
            position: absolute;
            width: 40px;
            height: 40px;
            animation: snakeMove 3s ease-in-out infinite;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .snake-head img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .snake-body {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .snake-segment {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--wisag-green);
            border-radius: 50%;
            opacity: 0.8;
        }

        .snake-segment:nth-child(1) {
            animation: snakeMove 3s ease-in-out infinite 0.1s;
            animation-fill-mode: both;
        }

        .snake-segment:nth-child(2) {
            animation: snakeMove 3s ease-in-out infinite 0.2s;
            animation-fill-mode: both;
            opacity: 0.7;
        }

        .snake-segment:nth-child(3) {
            animation: snakeMove 3s ease-in-out infinite 0.3s;
            animation-fill-mode: both;
            opacity: 0.6;
        }

        .snake-segment:nth-child(4) {
            animation: snakeMove 3s ease-in-out infinite 0.4s;
            animation-fill-mode: both;
            opacity: 0.5;
        }

        .snake-segment:nth-child(5) {
            animation: snakeMove 3s ease-in-out infinite 0.5s;
            animation-fill-mode: both;
            opacity: 0.4;
        }

        @keyframes snakeMove {
            0% {
                left: 0;
                top: 50%;
                transform: translateY(-50%);
            }
            25% {
                left: 25%;
                top: 20%;
                transform: translateY(-50%) rotate(20deg);
            }
            50% {
                left: 50%;
                top: 50%;
                transform: translateY(-50%) rotate(0deg);
            }
            75% {
                left: 75%;
                top: 80%;
                transform: translateY(-50%) rotate(-20deg);
            }
            100% {
                left: 100%;
                top: 50%;
                transform: translateY(-50%);
            }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            text-align: center;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .loading-subtext {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Legacy spinner (fallback) */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid var(--white);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Results */
        .result-card {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            margin-top: 16px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .result-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .quality-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .quality-good {
            background: #d1fae5;
            color: #065f46;
        }

        /* Updated medium (distinct yellow) */
        .quality-medium {
            background: #fff7b3; /* lighter yellow */
            color: #7a5d00;
        }

        .quality-poor {
            background: #fee2e2;
            color: #991b1b;
        }

        .score-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            border: 4px solid;
        }

        .score-circle.good {
            border-color: var(--success-color);
            background: #d1fae5;
            color: #065f46;
        }

        .score-circle.medium {
            border-color: #eab308; /* amber-500 */
            background: #fef9c3; /* light yellow */
            color: #854d0e;
        }

        .score-circle.poor {
            border-color: var(--danger-color);
            background: #fee2e2;
            color: #991b1b;
        }

        .score-label {
            font-size: 10px;
            font-weight: 600;
            margin-top: 2px;
        }

        .result-summary {
            margin-bottom: 20px;
            padding: 16px;
            background: var(--light);
            border-radius: 8px;
            font-size: 15px;
            line-height: 1.6;
        }

        .findings-list {
            margin-bottom: 20px;
        }

        .finding-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            background: var(--light);
        }

        .finding-status {
            font-size: 20px;
            flex-shrink: 0;
        }

        .finding-content {
            flex: 1;
        }

        .finding-aspect {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .finding-description {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .recommendations {
            background: #eff6ff;
            border-left: 4px solid var(--primary-color);
            padding: 16px;
            border-radius: 8px;
        }

        .recommendations h4 {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--primary-color);
        }

        .recommendations ul {
            list-style: none;
            padding: 0;
        }

        .recommendations li {
            padding: 8px 0;
            padding-left: 24px;
            position: relative;
            font-size: 13px;
            line-height: 1.5;
        }

        .recommendations li:before {
            content: '‚Üí';
            position: absolute;
            left: 0;
            color: var(--primary-color);
            font-weight: 700;
        }

        /* Stats Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #6db133 0%, #5a9429 100%);
            color: var(--white);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #facc15 0%, #eab308 100%);
        }

        .stat-card.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-container {
            margin-bottom: 20px;
        }

        .chart-bar {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .chart-label {
            width: 120px;
            font-size: 13px;
            font-weight: 600;
        }

        .chart-bar-bg {
            flex: 1;
            height: 32px;
            background: var(--light);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .chart-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #6db133 0%, #5a9429 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 12px;
            font-weight: 700;
            transition: width 0.5s;
        }

        /* History */
        .history-item {
            display: flex;
            gap: 16px;
            padding: 16px;
            border-radius: 12px;
            background: var(--white);
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .history-score {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            flex-shrink: 0;
            position: relative;
        }

        .history-content {
            flex: 1;
            min-width: 0;
        }

        .history-task {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .history-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .history-summary {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2; /* Safari/WebKit */
            line-clamp: 2; /* Standard */
            -webkit-box-orient: vertical;
        }

        .inline-edit-btn {
            background: var(--dark-light);
            color: #fff;
            border: none;
            padding: 4px 6px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
        }
        .inline-edit-btn:hover { background: var(--wisag-green); }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-message {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .empty-hint {
            font-size: 13px;
        }

        /* File Input */
        input[type="file"] {
            display: none;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--dark);
            color: var(--white);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s;
            max-width: 90%;
            text-align: center;
            pointer-events: none; /* do not block taps when hidden/off-screen */
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto; /* allow interaction only when visible */
        }

        .toast.error {
            background: var(--danger-color);
        }

        .toast.success {
            background: var(--success-color);
        }

        /* Mobile Optimizations */
    @media (max-width: 768px) {
            /* Compact header */
            .header {
                padding: 12px 16px;
                padding-top: calc(12px + env(safe-area-inset-top));
            }

            .header-content {
                flex-wrap: wrap;
                row-gap: 8px;
            }

            .logo-icon {
                width: 36px;
                height: 36px;
                flex-shrink: 0;
            }

            .logo-text h1 {
                font-size: 18px;
                white-space: normal;
            }

            .logo-text p {
                font-size: 11px;
                white-space: normal;
            }

            .logo {
                gap: 12px;
                flex: 1;
            }

            /* Compact user menu */
            .user-menu {
                gap: 8px;
            }

            .user-name {
                display: none;
            }

            .btn-logout {
                padding: 6px 12px;
                font-size: 12px;
            }

            /* Bottom nav stays fixed; add extra bottom padding for content */
            body { padding-bottom: calc(90px + env(safe-area-inset-bottom)); }
            .nav-tabs { padding-bottom: env(safe-area-inset-bottom); }

            .nav-tab {
                padding: 0 8px;
                font-size: 12px;
            }

            /* Compact tab content */
            .tab-content {
                padding: 16px 12px 60px;
            }

            /* Compact cards */
            .card {
                padding: 20px 16px;
                margin-bottom: 16px;
                border-radius: 12px;
            }

            .card-header {
                font-size: 17px;
                margin-bottom: 16px;
            }

            /* Compact buttons */
            .btn {
                padding: 12px 16px;
                font-size: 14px;
            }

            .btn-group {
                gap: 8px;
                margin-bottom: 12px;
            }

            /* Compact task selector */
            .task-selector {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .task-option {
                padding: 10px 8px;
            }

            .task-icon {
                font-size: 24px;
                margin-bottom: 4px;
            }

            .task-name {
                font-size: 11px;
                line-height: 1.2;
            }

            /* Compact stats grid */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-value {
                font-size: 28px;
                margin-bottom: 6px;
            }

            .stat-label {
                font-size: 11px;
            }

            /* Compact history items */
            .history-item {
                padding: 14px;
                margin-bottom: 10px;
            }

            .history-score {
                width: 50px;
                height: 50px;
                font-size: 18px;
            }

            .history-task {
                font-size: 14px;
                margin-bottom: 4px;
            }

            .history-time {
                font-size: 11px;
            }

            .history-summary {
                font-size: 12px;
            }

            /* Compact result cards */
            .result-card {
                padding: 18px;
            }

            .result-header {
                margin-bottom: 16px;
            }

            .score-badge {
                width: 70px;
                height: 70px;
                font-size: 26px;
            }

            .quality-badge {
                padding: 6px 14px;
                font-size: 12px;
            }

            /* Compact batch results */
            .summary-stat {
                padding: 14px;
            }

            .summary-value {
                font-size: 28px;
            }

            .summary-label {
                font-size: 11px;
            }

            /* Compact upload mode selector */
            #uploadModeSelect {
                padding: 10px;
                font-size: 13px;
                border-radius: 6px;
            }

            /* Reduce vertical spacing between sections */
            .card + .card {
                margin-top: 12px;
            }

            /* More compact result displays */
            .result-card {
                padding: 16px 14px;
            }

            .result-header {
                margin-bottom: 12px;
                gap: 12px;
            }

            .result-summary {
                font-size: 13px;
                margin-bottom: 12px;
            }

            .finding-item {
                padding: 10px;
                margin-bottom: 8px;
            }

            .finding-aspect {
                font-size: 13px;
                margin-bottom: 3px;
            }

            .finding-description {
                font-size: 12px;
            }

            /* Reduce snake loader size */
            .snake-loader-container {
                padding: 40px 20px;
            }

            .loading-text {
                font-size: 14px;
            }

            .loading-subtext {
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .task-selector {
                grid-template-columns: 1fr;
            }
        }

        .language-switcher {
            display: flex;
            gap: 4px;
            margin-left: 12px;
        }

        .lang-btn-small {
            background: rgba(109, 177, 51, 0.1);
            border: 1px solid rgba(109, 177, 51, 0.3);
            color: var(--wisag-green);
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .lang-btn-small:hover {
            background: rgba(109, 177, 51, 0.2);
        }

        .lang-btn-small.active {
            background: var(--wisag-green);
            color: white;
        }
    </style>
    <script src="translations.js"></script>
    <script src="auth-helper.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <img src="assets/wisag-logo.png" alt="WISAG" onerror="this.style.display='none'; this.parentElement.innerHTML='üü¢';">
                    </div>
                    <div class="logo-text">
                        <h1>AI CleanCheck</h1>
                        <p>WISAG Quality Assurance</p>
                    </div>
                </div>
                <div class="user-menu">
                    <!-- <div class="status-indicator" id="statusIndicator"></div> -->
                    <span class="user-name" id="userName">User</span>
                    <div class="language-switcher">
                        <button class="lang-btn-small" onclick="setLanguage('en')">EN</button>
                        <button class="lang-btn-small" onclick="setLanguage('de')">DE</button>
                        <button class="lang-btn-small" onclick="setLanguage('ro')">RO</button>
                    </div>
                    <button class="btn-logout" onclick="logout()"><span data-i18n="header.logout">üö™ Logout</span></button>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs" id="bottomNav">
            <button class="nav-tab active" onclick="switchTab('inspect', event)"><span data-i18n="nav.inspect">üì∏ Inspect</span></button>
            <button class="nav-tab" onclick="switchTab('dashboard', event)"><span data-i18n="nav.dashboard">üìä Dashboard</span></button>
            <button class="nav-tab" onclick="switchTab('history', event)"><span data-i18n="nav.history">üìã History</span></button>
            <button class="nav-tab" id="usersTab" onclick="switchTab('users', event)" style="display:none;"><span data-i18n="nav.users">üë• Users</span></button>
        </div>

        <!-- Tab: Inspect -->
        <div id="tab-inspect" class="tab-content active">
            <!-- Upload Mode Selector -->
            <div class="card">
                <div class="card-header" data-i18n="inspect.uploadMode">üì§ Upload Mode</div>
                <select id="uploadModeSelect" onchange="switchUploadMode()" style="width: 100%; padding: 12px; font-size: 15px; border: 1px solid var(--border-color); border-radius: 8px; background: white; color: var(--text-primary); cursor: pointer;">
                    <option value="single" data-i18n="inspect.singleImage">üì∏ Single Image - Analyze one image at a time</option>
                    <option value="batch" data-i18n="inspect.batchUpload">üì¶ Batch Upload - Analyze up to 10 images at once</option>
                </select>
            </div>

            <!-- Task Selector -->
            <div class="card">
                <div class="card-header-row">
                    <div class="card-header" style="margin-bottom:0;" data-i18n="inspect.taskSelection">Select Cleaning Task</div>
                    <div class="task-selector inline" id="taskSelector"></div>
                </div>
                <div class="task-dropdown-wrapper" id="manualTaskWrapper" style="display:none;">
                    <label for="manualTaskSelect" style="font-size:12px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-secondary);" data-i18n="inspect.manualSelect">Manual Tasks</label>
                    <select id="manualTaskSelect" onchange="manualTaskChanged()">
                        <option value="" data-i18n="inspect.chooseTask">-- Choose Task --</option>
                    </select>
                </div>
            </div>

            <!-- Single Upload Section -->
            <div id="singleUploadSection">
                <div class="card">
                    <div class="card-header" data-i18n="inspect.captureArea">Capture Cleaning Area</div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="document.getElementById('cameraInput').click()">
                            <span data-i18n="inspect.takePhoto">üì∑ Take Photo</span>
                        </button>
                        <button class="btn btn-primary" onclick="document.getElementById('galleryInput').click()">
                            <span data-i18n="inspect.uploadPhoto">üìÅ Upload Photo</span>
                        </button>
                    </div>
                    <input type="file" id="cameraInput" accept="image/*" capture onchange="handleFileUpload(event)" style="display: none;">
                    <input type="file" id="galleryInput" accept="image/*" onchange="handleFileUpload(event)" style="display: none;">

                    <!-- Live capture removed: analysis starts after selecting a photo -->

                </div>
            </div>

            <!-- Batch Upload Section -->
            <div id="batchUploadSection" style="display: none;">
                <div class="card">
                    <div class="card-header" data-i18n="inspect.batchUpload">üì¶ Batch Upload (Up to 10 Images)</div>
                    <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">
                        Upload multiple images at once for bulk quality inspection. Perfect for checking an entire area quickly!
                    </p>

                    <button class="btn btn-primary" onclick="document.getElementById('batchFileInput').click()">
                        <span data-i18n="inspect.selectMultiple">üì§ Select Multiple Images (Max 10)</span>
                    </button>
                    <input type="file" id="batchFileInput" accept="image/*" multiple onchange="handleBatchUpload(event)" style="display: none;">

                    <div id="batchPreview" style="display: none; margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <strong id="batchCount">0 <span data-i18n="inspect.imagesSelected">images selected</span></strong>
                            <button class="btn btn-secondary" onclick="clearBatchSelection()" style="width: auto; padding: 8px 16px; font-size: 13px;">
                                <span data-i18n="inspect.clearAll">Clear All</span>
                            </button>
                        </div>
                        <div id="batchImageList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 12px; margin-bottom: 20px;"></div>
                        <button class="btn btn-success" id="batchAnalyzeBtn" onclick="analyzeBatch()">
                            <span data-i18n="inspect.analyzeAll">üîç Analyze All Images</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="resultContainer"></div>
        </div>

        <!-- Tab: Dashboard -->
        <div id="tab-dashboard" class="tab-content">
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-value" id="totalInspections">0</div>
                    <div class="stat-label" data-i18n="dashboard.totalInspections">Total Inspections</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value" id="averageScore">0</div>
                    <div class="stat-label" data-i18n="dashboard.averageScore">Average Score</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value" id="goodCount">0</div>
                    <div class="stat-label" data-i18n="dashboard.good">Good Quality</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" id="mediumCount">0</div>
                    <div class="stat-label" data-i18n="dashboard.medium">Medium Quality</div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-value" id="poorCount">0</div>
                    <div class="stat-label" data-i18n="dashboard.poor">Poor Quality</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header" data-i18n="dashboard.qualityDistribution">Quality Distribution</div>
                <div class="chart-container" id="qualityChart"></div>
            </div>

            <div class="card">
                <div class="card-header" data-i18n="dashboard.taskDistribution">Task Distribution</div>
                <div class="chart-container" id="taskChart"></div>
            </div>
        </div>

        <!-- Tab: History -->
        <div id="tab-history" class="tab-content">
            <div class="card">
                <div class="card-header" data-i18n="history.title">Recent Inspections</div>
                <div id="historyList"></div>
            </div>
        </div>

        <!-- Tab: Users (Admin Only) -->
        <div id="tab-users" class="tab-content">
            <div class="card">
                <div class="card-header" data-i18n="users.title">üë• User Management</div>
                <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;" data-i18n="users.subtitle">
                    Create and manage staff cleaner accounts (Maximum 2 staff members)
                </p>

                <!-- Create User Form -->
                <form onsubmit="createUser(event)" style="margin-bottom: 24px;">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;" data-i18n="users.username">Username</label>
                        <input type="text" id="newUsername" required
                               style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;" data-i18n="users.fullName">Full Name</label>
                        <input type="text" id="newName" required
                               style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;" data-i18n="users.password">Password</label>
                        <input type="password" id="newPassword" required
                               style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px;">
                    </div>
                    <button type="submit" class="btn btn-primary"><span data-i18n="users.createUser">‚ûï Create Staff User</span></button>
                </form>

                <!-- Users List -->
                <div id="usersList"></div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Edit Score Modal -->
    <div id="editScoreModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 12px; padding: 24px; width: 90%; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <h3 style="margin: 0 0 20px 0; color: var(--text-primary);" data-i18n="history.editScore">Edit Score</h3>
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;" data-i18n="history.newScore">New Score (0-100)</label>
                <input type="number" id="newScoreInput" min="0" max="100" step="1"
                       style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 16px;">
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="closeEditScoreModal()" class="btn btn-secondary" style="width: auto; padding: 10px 20px;">
                    <span data-i18n="history.cancel">Cancel</span>
                </button>
                <button onclick="updateScore()" class="btn btn-primary" style="width: auto; padding: 10px 20px;">
                    <span data-i18n="history.updateScore">Update Score</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Check authentication
        function checkAuth() {
            const session = localStorage.getItem('wisag_session');
            if (!session) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Logout function
        function logout() {
            if (confirm(t('header.logoutConfirm'))) {
                localStorage.removeItem('wisag_session');
                window.location.href = 'login.html';
            }
        }

        // Check auth on page load
        if (!checkAuth()) {
            // Will redirect to login
        }

        // Configuration
        // Resolve API URL dynamically to work on localhost and LAN/mobile
        const API_URL = (() => {
            try {
                const isHttp = window.location.protocol.startsWith('http');
                const host = window.location.hostname || 'localhost';
                const protocol = isHttp ? window.location.protocol : 'http:';
                return `${protocol}//${host}:3000/api`;
            } catch (e) {
                return 'http://localhost:3000/api';
            }
        })();

        // State
        let currentStream = null;
        let selectedTask = 'auto-detect'; // Default to auto-detection
        let capturedImage = null;
        let batchImages = [];
        let batchResults = [];

        // Task Icons
        const TASK_ICONS = {
            'trash-bin': 'üóëÔ∏è',
            'whiteboard': 'üìù',
            'desk-surface': 'üóÉÔ∏è',
            'floor': 'üßπ',
            'window': 'ü™ü'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Display username
            const session = JSON.parse(localStorage.getItem('wisag_session'));
            if (session && session.user) {
                const userNameEl = document.getElementById('userName');
                if (userNameEl) {
                    userNameEl.textContent = session.user.name;
                }
            }

            // Check if user is admin to show/hide users tab
            checkAdminAccess();

            await loadTasks();
            await checkAPIStatus();
            await loadHistory();
            await loadStats();
        });

        // API Status Check
        async function checkAPIStatus() {
            try {
                const response = await fetch(`${API_URL}/health`);
                if (response.ok) {
                    document.getElementById('statusIndicator').style.backgroundColor = 'var(--success-color)';
                } else {
                    throw new Error('API not responding');
                }
            } catch (error) {
                document.getElementById('statusIndicator').style.backgroundColor = 'var(--danger-color)';
                showToast('‚ö†Ô∏è Cannot connect to API. Please start the backend server.', 'error');
            }
        }

        // Switch between Single and Batch Upload Modes
        function switchUploadMode() {
            const mode = document.getElementById('uploadModeSelect').value;
            const singleSection = document.getElementById('singleUploadSection');
            const batchSection = document.getElementById('batchUploadSection');

            if (mode === 'single') {
                singleSection.style.display = 'block';
                batchSection.style.display = 'none';
            } else if (mode === 'batch') {
                singleSection.style.display = 'none';
                batchSection.style.display = 'block';
            }
        }

        // Load Tasks
        async function loadTasks() {
            try {
                const response = await fetch(`${API_URL}/tasks`);
                const tasks = await response.json();

                const taskSelector = document.getElementById('taskSelector');
                taskSelector.innerHTML = '';
                const manualTaskWrapper = document.getElementById('manualTaskWrapper');
                const manualTaskSelect = document.getElementById('manualTaskSelect');
                manualTaskSelect.innerHTML = '<option value="">-- Choose Task --</option>';

                // Auto-detect prominent card
                const autoDetectDiv = document.createElement('div');
                autoDetectDiv.className = `task-option ${selectedTask === 'auto-detect' ? 'selected' : ''}`;
                autoDetectDiv.setAttribute('data-task', 'auto-detect');
                autoDetectDiv.onclick = () => selectTask('auto-detect');
                autoDetectDiv.innerHTML = `
                    <div class="task-icon">ü§ñ</div>
                    <div class="task-name">Auto-detect</div>
                `;
                taskSelector.appendChild(autoDetectDiv);

                // Populate dropdown with remaining tasks
                Object.entries(tasks).forEach(([key, task]) => {
                    const opt = document.createElement('option');
                    opt.value = key;
                    const icon = TASK_ICONS[key] || 'üìã';
                    opt.textContent = `${icon} ${task.name}`;
                    if (key === selectedTask) opt.selected = true;
                    manualTaskSelect.appendChild(opt);
                });

                manualTaskWrapper.style.display = 'block';
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }

        // Select Task
        function selectTask(taskKey) {
            selectedTask = taskKey;
            // Highlight only auto-detect card if chosen
            document.querySelectorAll('.task-option').forEach(el => el.classList.remove('selected'));
            const autoCard = document.querySelector('.task-option[data-task="auto-detect"]');
            if (taskKey === 'auto-detect' && autoCard) autoCard.classList.add('selected');
            // Sync dropdown selection if manual
            if (taskKey !== 'auto-detect') {
                const manualTaskSelect = document.getElementById('manualTaskSelect');
                if (manualTaskSelect) manualTaskSelect.value = taskKey;
            }
        }

        function manualTaskChanged() {
            const value = document.getElementById('manualTaskSelect').value;
            if (value) {
                selectTask(value);
            } else {
                selectTask('auto-detect');
            }
        }

        // Select Task Programmatically (without event)
        function selectTaskByKey(taskKey) {
            selectedTask = taskKey;
            document.querySelectorAll('.task-option').forEach(el => {
                el.classList.remove('selected');
            });
            const targetOption = document.querySelector(`.task-option[data-task="${taskKey}"]`);
            if (targetOption) {
                targetOption.classList.add('selected');
            }
        }

        // Start Camera
        // async function startCamera() {
        //     try {
        //         const constraints = {
        //             video: {
        //                 facingMode: 'environment',
        //                 width: { ideal: 1920 },
        //                 height: { ideal: 1080 }
        //             }
        //         };

        //         currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        //         const video = document.getElementById('video');
        //         video.srcObject = currentStream;
        //         video.style.display = 'block';
        //         document.getElementById('cameraPlaceholder').style.display = 'none';
        //         document.getElementById('captureBtn').disabled = false;
        //         document.getElementById('startCameraBtn').textContent = 'üî¥ Stop Camera';
        //         document.getElementById('startCameraBtn').onclick = stopCamera;
        //     } catch (error) {
        //         console.error('Error accessing camera:', error);

        //         // Better error messages for different scenarios
        //         const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        //         const isHTTPS = window.location.protocol === 'https:';

        //         let message = '‚ùå Live Camera unavailable. ';

        //         if (isSafari && !isHTTPS) {
        //             message += 'Safari requires HTTPS for camera. Use "Take/Upload Photo" button instead! üì∏';
        //         } else if (error.name === 'NotAllowedError') {
        //             message += 'Please allow camera permissions. Or use "Take/Upload Photo" button. üì∏';
        //         } else if (error.name === 'NotFoundError') {
        //             message += 'No camera found. Use "Take/Upload Photo" button. üì∏';
        //         } else {
        //             message += 'Use "Take/Upload Photo" button instead. üì∏';
        //         }

        //         showToast(message, 'error');
        //     }
        // }

        // Stop Camera
        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
                const video = document.getElementById('video');
                if (video) video.style.display = 'none';
                const placeholder = document.getElementById('cameraPlaceholder');
                if (placeholder) placeholder.style.display = 'flex';
                const captureBtn = document.getElementById('captureBtn');
                if (captureBtn) captureBtn.disabled = true;
                // document.getElementById('startCameraBtn').textContent = 'üì∑ Live Camera';
                // document.getElementById('startCameraBtn').onclick = startCamera;
            }
        }

        // Handle File Upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                capturedImage = e.target.result;
                stopCamera();
                analyzeImage(capturedImage);
            };
            reader.readAsDataURL(file);
        }

        // Handle Batch Upload
        function handleBatchUpload(event) {
            const files = Array.from(event.target.files);

            if (files.length === 0) return;

            if (files.length > 10) {
                showToast('‚ö†Ô∏è Maximum 10 images allowed. Only first 10 will be processed.', 'error');
                files = files.slice(0, 10);
            }

            batchImages = [];
            const batchImageList = document.getElementById('batchImageList');
            const batchPreview = document.getElementById('batchPreview');
            const batchCount = document.getElementById('batchCount');

            batchImageList.innerHTML = '';

            let processedCount = 0;

            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    batchImages.push({
                        data: e.target.result,
                        name: file.name,
                        index: index
                    });

                    // Create thumbnail preview
                    const thumbnail = document.createElement('div');
                    thumbnail.style.cssText = `
                        position: relative;
                        aspect-ratio: 1;
                        border-radius: 8px;
                        overflow: hidden;
                        border: 2px solid var(--border-color);
                    `;

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';

                    const label = document.createElement('div');
                    label.textContent = `#${index + 1}`;
                    label.style.cssText = `
                        position: absolute;
                        top: 4px;
                        left: 4px;
                        background: var(--wisag-green);
                        color: white;
                        padding: 2px 6px;
                        border-radius: 4px;
                        font-size: 11px;
                        font-weight: 600;
                    `;

                    thumbnail.appendChild(img);
                    thumbnail.appendChild(label);
                    batchImageList.appendChild(thumbnail);

                    processedCount++;
                    batchCount.textContent = `${processedCount} image${processedCount > 1 ? 's' : ''} selected`;

                    if (processedCount === files.length) {
                        batchPreview.style.display = 'block';
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        function clearBatchSelection() {
            batchImages = [];
            document.getElementById('batchPreview').style.display = 'none';
            document.getElementById('batchFileInput').value = '';
            document.getElementById('batchImageList').innerHTML = '';
        }

        async function analyzeBatch() {
            if (batchImages.length === 0) {
                showToast(`‚ùå ${t('messages.noImagesSelected')}`, 'error');
                return;
            }

            const resultContainer = document.getElementById('resultContainer');
            batchResults = [];

            // Show loading state
            resultContainer.innerHTML = `
                <div class="card">
                    <div class="snake-loader-container">
                        <div class="snake-path">
                            <div class="snake-head">
                                <img src="assets/wisag-logo.png" alt="WISAG Logo">
                            </div>
                            <div class="snake-body">
                                <div class="snake-segment"></div>
                                <div class="snake-segment"></div>
                                <div class="snake-segment"></div>
                                <div class="snake-segment"></div>
                                <div class="snake-segment"></div>
                            </div>
                        </div>
                        <div class="loading-text">${t('messages.processingImages', {count: batchImages.length})}</div>
                        <div class="loading-subtext">This may take a moment</div>
                    </div>
                </div>
            `;

            try {
                // Process images sequentially
                for (let i = 0; i < batchImages.length; i++) {
                    const img = batchImages[i];

                    // Update loading message
                    const loadingText = document.querySelector('.loading-text');
                    if (loadingText) {
                        loadingText.textContent = t('messages.analyzingImage', {current: i + 1, total: batchImages.length});
                    }

                    const response = await authFetch(`${API_URL}/analyze`, {
                        method: 'POST',
                        body: {
                            imageData: img.data,
                            taskType: selectedTask,
                            metadata: {
                                timestamp: new Date().toISOString(),
                                batchIndex: i,
                                batchTotal: batchImages.length,
                                imageName: img.name
                            }
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Analysis failed for image ${i + 1}`);
                    }

                    const result = await response.json();
                    batchResults.push({
                        ...result,
                        imageName: img.name,
                        imageData: img.data
                    });
                }

                // Display batch results
                displayBatchResults(batchResults);
                await loadHistory();
                await loadStats();
                showToast(`‚úÖ ${t('messages.successfullyAnalyzed', {count: batchResults.length})}`, 'success');

            } catch (error) {
                console.error('Error in batch analysis:', error);
                resultContainer.innerHTML = `
                    <div class="card" style="background: #fee2e2; border-left: 4px solid var(--danger-color);">
                        <div class="card-header" style="color: var(--danger-color);">‚ùå ${t('messages.batchAnalysisFailed')}</div>
                        <p style="color: var(--text-secondary); margin-bottom: 0;">${error.message}</p>
                        <p style="color: var(--text-secondary); margin-top: 12px; font-size: 13px;">
                            ${t('messages.successfullyAnalyzedPartial', {count: batchResults.length, total: batchImages.length})}
                        </p>
                    </div>
                `;
                showToast(`‚ùå ${t('messages.batchAnalysisError')}`, 'error');
            }
        }

        function displayBatchResults(results) {
            const resultContainer = document.getElementById('resultContainer');

            // Calculate aggregate statistics
            const avgScore = Math.round(results.reduce((sum, r) => sum + r.assessment.overallScore, 0) / results.length);
            const qualityCounts = {
                GOOD: results.filter(r => r.assessment.quality === 'GOOD').length,
                MEDIUM: results.filter(r => r.assessment.quality === 'MEDIUM').length,
                POOR: results.filter(r => r.assessment.quality === 'POOR').length
            };

            let html = `
                <div class="card">
                    <div class="card-header">üìä Batch Analysis Summary</div>

                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;">
                        <div style="text-align: center; padding: 20px; background: var(--light); border-radius: 12px;">
                            <div style="font-size: 36px; font-weight: 700; color: var(--wisag-green);">${results.length}</div>
                            <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">Images Analyzed</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: var(--light); border-radius: 12px;">
                            <div style="font-size: 36px; font-weight: 700; color: var(--wisag-green);">${avgScore}</div>
                            <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">Average Score</div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                        <div style="flex: 1; text-align: center; padding: 12px; background: #d1fae5; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 700; color: #065f46;">${qualityCounts.GOOD}</div>
                            <div style="font-size: 12px; color: #065f46;">Good</div>
                        </div>
                        <div style="flex: 1; text-align: center; padding: 12px; background: #fef3c7; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 700; color: #92400e;">${qualityCounts.MEDIUM}</div>
                            <div style="font-size: 12px; color: #92400e;">Medium</div>
                        </div>
                        <div style="flex: 1; text-align: center; padding: 12px; background: #fee2e2; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 700; color: #991b1b;">${qualityCounts.POOR}</div>
                            <div style="font-size: 12px; color: #991b1b;">Poor</div>
                        </div>
                    </div>

                    <button class="btn btn-secondary" onclick="toggleDetailedResults()" style="margin-bottom: 0;">
                        <span id="toggleDetailsText">üìã Show Detailed Results</span>
                    </button>
                </div>

                <div id="detailedResults" style="display: none;">
            `;

            results.forEach((result, index) => {
                const qualityClass = result.assessment.quality.toLowerCase();
                const hasObservations = result.assessment.observations && result.assessment.observations.length > 0;
                const canvasId = `batchCanvas${index}`;

                html += `
                    <div class="result-card" style="margin-top: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                            <div>
                                <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">
                                    #${index + 1}: ${result.taskName}
                                </div>
                                ${result.assessment.detectedTaskType ? `
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">
                                        ü§ñ Auto-detected: ${result.assessment.taskName || result.taskName}
                                    </div>
                                ` : ''}
                                <div style="font-size: 13px; color: var(--text-secondary);">${result.imageName || 'Image ' + (index + 1)}</div>
                            </div>
                            <div class="score-circle ${qualityClass}" style="width: 60px; height: 60px; font-size: 20px;">
                                <div>${result.assessment.overallScore}</div>
                                <div class="score-label">SCORE</div>
                            </div>
                        </div>

                        <div class="quality-badge quality-${qualityClass}" style="display: inline-block; margin-bottom: 16px;">
                            ${result.assessment.quality}
                        </div>

                        ${hasObservations && result.imageData ? `
                            <div style="margin: 16px 0;">
                                <div style="font-weight: 600; margin-bottom: 8px;">üìç Visual Inspection Map</div>
                                <div style="position: relative; background: #f8f9fa; border-radius: 8px; overflow: hidden;">
                                    <canvas id="${canvasId}" style="width: 100%; height: auto; display: block;"></canvas>
                                </div>
                                <div style="margin-top: 8px; padding: 8px; background: #f0f9ff; border-radius: 6px; font-size: 12px;">
                                    <strong>Accuracy code:</strong>
                                    <span style="color: #dc2626;">üî¥ High</span> |
                                    <span style="color: #ea580c;">üü† Medium</span> |
                                    <span style="color: #0891b2;">üîµ Low</span>
                                </div>
                            </div>
                            <div style="padding: 10px; background: #fefce8; border-radius: 8px; border-left: 3px solid #eab308; margin-bottom: 16px;">
                                <div style="font-weight: 600; font-size: 13px; color: #854d0e; margin-bottom: 8px;">
                                    üîç ${result.assessment.observations.length} Observations Detected
                                </div>
                                <div style="display: grid; gap: 6px;">
                                    ${result.assessment.observations.map((obs, obsIdx) => {
                                        const severityIcons = { HIGH: 'üî¥', MEDIUM: 'üü†', LOW: 'üîµ' };
                                        return `
                                            <div style="padding: 6px; background: white; border-radius: 4px; font-size: 12px;">
                                                ${severityIcons[obs.severity]} <strong>${obs.item}</strong>
                                                <span style="color: var(--text-secondary);">(${obs.type}) - X:${Math.round(obs.x)}%, Y:${Math.round(obs.y)}%</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <div class="result-summary">
                            <strong>Summary:</strong> ${result.assessment.summary}
                        </div>

                        <details style="margin-top: 16px;">
                            <summary style="cursor: pointer; font-weight: 600; margin-bottom: 12px;">View Detailed Findings</summary>
                            <div class="findings-list">
                                ${result.assessment.findings.map(finding => `
                                    <div class="finding-item">
                                        <div class="finding-status">${finding.status === 'PASS' ? '‚úÖ' : '‚ùå'}</div>
                                        <div class="finding-content">
                                            <div class="finding-aspect">${finding.aspect}</div>
                                            <div class="finding-description">${finding.description}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>

                            ${result.assessment.recommendations && result.assessment.recommendations.length > 0 ? `
                                <div class="recommendations" style="margin-top: 16px;">
                                    <h4>üí° Recommendations</h4>
                                    <ul>
                                        ${result.assessment.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </details>
                    </div>
                `;

                // Queue canvas drawing for after DOM update
                if (hasObservations && result.imageData) {
                    setTimeout(() => {
                        const canvas = document.getElementById(canvasId);
                        if (canvas) {
                            drawObservationsToBatchCanvas(canvas, result.imageData, result.assessment.observations);
                        }
                    }, 100);
                }
            });

            html += '</div>';
            resultContainer.innerHTML = html;

            // Scroll to results
            resultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function toggleDetailedResults() {
            const detailedResults = document.getElementById('detailedResults');
            const toggleText = document.getElementById('toggleDetailsText');

            if (detailedResults.style.display === 'none') {
                detailedResults.style.display = 'block';
                toggleText.textContent = 'üìã Hide Detailed Results';
            } else {
                detailedResults.style.display = 'none';
                toggleText.textContent = 'üìã Show Detailed Results';
            }
        }

        // Capture and Analyze
        function captureAndAnalyze() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            capturedImage = canvas.toDataURL('image/jpeg', 0.9);
            stopCamera();
            analyzeImage(capturedImage);
        }

        // Analyze Image
        async function analyzeImage(imageData) {
            const resultContainer = document.getElementById('resultContainer');
            resultContainer.innerHTML = `
                <div class="card">
                    <div class="snake-loader-container">
                        <div class="snake-path">
                            <div class="snake-head">
                                <img src="assets/wisag-logo.png" alt="WISAG Logo">
                            </div>
                            <div class="snake-body">
                                <div class="snake-segment"></div>
                                <div class="snake-segment"></div>
                                <div class="snake-segment"></div>
                                <div class="snake-segment"></div>
                                <div class="snake-segment"></div>
                            </div>
                        </div>
                        <div class="loading-text">AI is analyzing your image...</div>
                        <div class="loading-subtext">Powered by WISAG Quality Standards</div>
                    </div>
                </div>
            `;

            try {
                const response = await authFetch(`${API_URL}/analyze`, {
                    method: 'POST',
                    body: {
                        imageData: imageData,
                        taskType: selectedTask,
                        metadata: {
                            timestamp: new Date().toISOString(),
                            userAgent: navigator.userAgent
                        }
                    }
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }

                const result = await response.json();
                displayResult(result, imageData);
                await loadHistory();
                await loadStats();
                showToast(`‚úÖ ${t('messages.analysisComplete')}`, 'success');
            } catch (error) {
                console.error('Error analyzing image:', error);
                resultContainer.innerHTML = `
                    <div class="card" style="background: #fee2e2; border-left: 4px solid var(--danger-color);">
                        <div class="card-header" style="color: var(--danger-color);">‚ùå Analysis Failed</div>
                        <p style="color: var(--text-secondary); margin-bottom: 0;">${error.message}</p>
                    </div>
                `;
                showToast('‚ùå Analysis failed. Please try again.', 'error');
            }
        }

        // Display Result
        function displayResult(result, imageData = null) {
            const { assessment, taskName } = result;
            const qualityClass = assessment.quality.toLowerCase();

            const resultContainer = document.getElementById('resultContainer');

            // Check if we have observations to visualize
            const hasObservations = assessment.observations && assessment.observations.length > 0;

            resultContainer.innerHTML = `
                <div class="result-card">
                    ${hasObservations && imageData ? `
                        <div class="card" style="margin-bottom: 24px;">
                            <div class="card-header">üìç Visual Inspection Map</div>
                            <div style="position: relative; background: #f8f9fa; border-radius: 12px; overflow: hidden;">
                                <canvas id="observationCanvas" style="width: 100%; height: auto; display: block;"></canvas>
                            </div>
                            <div style="margin-top: 12px; padding: 12px; background: #f0f9ff; border-radius: 8px; font-size: 13px;">
                                <strong>Accuracy code:</strong>
                                <span style="color: #dc2626;">üî¥ High</span> |
                                <span style="color: #ea580c;">üü† Medium</span> |
                                <span style="color: #0891b2;">üîµ Low</span>
                            </div>
                        </div>
                    ` : ''}

                    <div class="result-header">
                        <div>
                            <h3 style="font-size: 20px; margin-bottom: 8px;">${taskName}</h3>
                            ${assessment.detectedTaskType ? `
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                                    ü§ñ Auto-detected: ${assessment.taskName || taskName}
                                </div>
                            ` : ''}
                            <div class="quality-badge quality-${qualityClass}">${assessment.quality}</div>
                        </div>
                        <div class="score-circle ${qualityClass}">
                            <div>${assessment.overallScore}</div>
                            <div class="score-label">SCORE</div>
                        </div>
                    </div>

                    <div class="result-summary">
                        <strong>Summary:</strong> ${assessment.summary}
                    </div>

                    ${hasObservations ? `
                        <div class="card" style="margin: 20px 0; background: #fefce8; border-left: 4px solid #eab308;">
                            <div style="font-weight: 600; margin-bottom: 12px; color: #854d0e;">üîç ${assessment.observations.length} Observations Detected</div>
                            <div style="display: grid; gap: 8px;">
                                ${assessment.observations.map((obs, idx) => {
                                    const severityColors = {
                                        HIGH: '#dc2626',
                                        MEDIUM: '#ea580c',
                                        LOW: '#0891b2'
                                    };
                                    const severityIcons = {
                                        HIGH: 'üî¥',
                                        MEDIUM: 'üü†',
                                        LOW: 'üîµ'
                                    };
                                    return `
                                        <div style="padding: 10px; background: white; border-radius: 6px; font-size: 13px;">
                                            ${severityIcons[obs.severity]} <strong>${obs.item}</strong>
                                            <span style="color: var(--text-secondary);">(${obs.type}) - Position: X:${Math.round(obs.x)}%, Y:${Math.round(obs.y)}%</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div class="findings-list">
                        <h4 style="font-size: 16px; margin-bottom: 12px;">Detailed Findings</h4>
                        ${assessment.findings.map(finding => `
                            <div class="finding-item">
                                <div class="finding-status">${finding.status === 'PASS' ? '‚úÖ' : '‚ùå'}</div>
                                <div class="finding-content">
                                    <div class="finding-aspect">${finding.aspect}</div>
                                    <div class="finding-description">${finding.description}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    ${assessment.recommendations && assessment.recommendations.length > 0 ? `
                        <div class="recommendations">
                            <h4>üí° Recommendations</h4>
                            <ul>
                                ${assessment.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); color: var(--text-secondary); font-size: 12px;">
                        Confidence: ${assessment.confidence}% | ${new Date(result.timestamp).toLocaleString()}
                    </div>
                </div>
            `;

            // Draw observations on canvas if available
            if (hasObservations && imageData) {
                drawObservationsOnCanvas(imageData, assessment.observations);
            }

            // Scroll to result
            resultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Draw observations on canvas with coordinate axes
        function drawObservationsOnCanvas(imageData, observations) {
            const canvas = document.getElementById('observationCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const img = new Image();

            img.onload = function() {
                // Set canvas size to match image
                canvas.width = img.width;
                canvas.height = img.height;

                // Draw the original image
                ctx.drawImage(img, 0, 0);

                // Draw observations with coordinate axes
                observations.forEach((obs, idx) => {
                    const x = (obs.x / 100) * canvas.width;
                    const y = (obs.y / 100) * canvas.height;

                    // Color based on severity
                    const colors = {
                        HIGH: '#dc2626',
                        MEDIUM: '#ea580c',
                        LOW: '#0891b2'
                    };
                    const color = colors[obs.severity] || '#6b7280';

                    // Draw vertical axis line
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();

                    // Draw horizontal axis line
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();

                    // Reset line dash
                    ctx.setLineDash([]);

                    // Draw crosshair circle at intersection
                    ctx.fillStyle = color;
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(x, y, 12, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.stroke();

                    // Draw label background
                    const label = `${idx + 1}. ${obs.item}`;
                    const labelPadding = 10;
                    const fontSize = 20;
                    ctx.font = `bold ${fontSize}px -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif`;
                    const labelWidth = ctx.measureText(label).width;

                    // Position label (try to keep it in bounds)
                    let labelX = x + 20;
                    let labelY = y - 10;
                    if (labelX + labelWidth + labelPadding * 2 > canvas.width) {
                        labelX = x - labelWidth - labelPadding * 2 - 20;
                    }
                    if (labelY - fontSize - labelPadding * 2 < 0) {
                        labelY = y + fontSize + labelPadding * 2 + 10;
                    }

                    // Draw label background
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                    ctx.fillRect(labelX, labelY - fontSize - labelPadding, labelWidth + labelPadding * 2, fontSize + labelPadding * 2);

                    // Draw label text
                    ctx.fillStyle = 'white';
                    ctx.fillText(label, labelX + labelPadding, labelY - labelPadding);

                    // Draw coordinates on axes
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                    ctx.font = `bold 16px -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif`;

                    // X coordinate at top
                    const xCoordText = `X:${Math.round(obs.x)}%`;
                    const xCoordWidth = ctx.measureText(xCoordText).width;
                    ctx.fillRect(x - xCoordWidth / 2 - 6, 5, xCoordWidth + 12, 24);
                    ctx.fillStyle = 'white';
                    ctx.fillText(xCoordText, x - xCoordWidth / 2, 22);

                    // Y coordinate at left
                    const yCoordText = `Y:${Math.round(obs.y)}%`;
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                    ctx.fillRect(5, y - 12, ctx.measureText(yCoordText).width + 12, 24);
                    ctx.fillStyle = 'white';
                    ctx.fillText(yCoordText, 11, y + 6);
                });
            };

            img.src = imageData;
        }

        // Draw observations on batch canvas
        function drawObservationsToBatchCanvas(canvas, imageData, observations) {
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const img = new Image();

            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);

                observations.forEach((obs, idx) => {
                    const x = (obs.x / 100) * canvas.width;
                    const y = (obs.y / 100) * canvas.height;
                    const colors = { HIGH: '#dc2626', MEDIUM: '#ea580c', LOW: '#0891b2' };
                    const color = colors[obs.severity] || '#6b7280';

                    // Draw axes
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    // Draw crosshair
                    ctx.fillStyle = color;
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(x, y, 12, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.stroke();

                    // Draw label
                    const label = `${idx + 1}. ${obs.item}`;
                    const labelPadding = 10;
                    const fontSize = 20;
                    ctx.font = `bold ${fontSize}px -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif`;
                    const labelWidth = ctx.measureText(label).width;

                    let labelX = x + 20;
                    let labelY = y - 10;
                    if (labelX + labelWidth + labelPadding * 2 > canvas.width) {
                        labelX = x - labelWidth - labelPadding * 2 - 20;
                    }
                    if (labelY - fontSize - labelPadding * 2 < 0) {
                        labelY = y + fontSize + labelPadding * 2 + 10;
                    }

                    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                    ctx.fillRect(labelX, labelY - fontSize - labelPadding, labelWidth + labelPadding * 2, fontSize + labelPadding * 2);
                    ctx.fillStyle = 'white';
                    ctx.fillText(label, labelX + labelPadding, labelY - labelPadding);

                    // Draw coordinates
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                    ctx.font = `bold 16px -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif`;
                    const xCoordText = `X:${Math.round(obs.x)}%`;
                    const xCoordWidth = ctx.measureText(xCoordText).width;
                    ctx.fillRect(x - xCoordWidth / 2 - 6, 5, xCoordWidth + 12, 24);
                    ctx.fillStyle = 'white';
                    ctx.fillText(xCoordText, x - xCoordWidth / 2, 22);

                    const yCoordText = `Y:${Math.round(obs.y)}%`;
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                    ctx.fillRect(5, y - 12, ctx.measureText(yCoordText).width + 12, 24);
                    ctx.fillStyle = 'white';
                    ctx.fillText(yCoordText, 11, y + 6);
                });
            };

            img.src = imageData;
        }

        // Load History
        async function loadHistory() {
            try {
                const response = await authFetch(`${API_URL}/history?limit=20`);
                const history = await response.json();

                const historyList = document.getElementById('historyList');

                if (history.length === 0) {
                    historyList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <div class="empty-message">${t('history.emptyMessage')}</div>
                            <div class="empty-hint">${t('history.emptyHint')}</div>
                        </div>
                    `;
                    return;
                }

                historyList.innerHTML = history.map(item => {
                    const qualityClass = item.assessment.quality.toLowerCase();
                    const formattedDate = formatDateTime(item.timestamp);
                    const currentUser = getCurrentUser();
                    const isAdmin = currentUser && currentUser.role === 'admin';

                    // Show creator name if admin is viewing
                    const creatorInfo = (isAdmin && item.userName)
                        ? `<div class="history-time">üë§ By: ${item.userName}</div>`
                        : '';

                    // Inline edit buttons for admins
                    const editScoreBtn = isAdmin
                        ? `<button onclick="openEditScoreModal('${item.id}', ${item.assessment.overallScore})" class="inline-edit-btn" title="${t('history.editScore')}">‚úèÔ∏è</button>`
                        : '';
                    const editDescBtn = isAdmin
                        ? `<button onclick="openEditDescription('${item.id}', event)" class="inline-edit-btn" title="Edit description">üìù</button>`
                        : '';

                    return `
                        <div class="history-item" style="position: relative;">
                            <div class="history-score ${qualityClass}" style="position:relative;">
                                ${item.assessment.overallScore}
                                <div style="font-size: 10px; margin-top: 4px;">${item.assessment.quality}</div>
                                ${editScoreBtn}
                            </div>
                            <div class="history-content">
                                <div class="history-task">${TASK_ICONS[item.taskType] || 'üìã'} ${item.taskName}</div>
                                ${creatorInfo}
                                <div class="history-time">üìÖ ${formattedDate}</div>
                                <div class="history-summary" id="summary-${item.id}" style="display:flex; align-items:flex-start; gap:6px;">
                                    <span class="description-text" style="flex:1;">${item.assessment.summary}</span>
                                    ${editDescBtn}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        // Load Stats
        async function loadStats() {
            try {
                const response = await authFetch(`${API_URL}/stats`);
                const stats = await response.json();

                document.getElementById('totalInspections').textContent = stats.totalInspections;
                document.getElementById('averageScore').textContent = stats.averageScore;
                document.getElementById('goodCount').textContent = stats.qualityDistribution.GOOD;
                document.getElementById('mediumCount').textContent = stats.qualityDistribution.MEDIUM;
                document.getElementById('poorCount').textContent = stats.qualityDistribution.POOR;

                // Quality Chart
                const qualityChart = document.getElementById('qualityChart');
                const total = stats.totalInspections || 1;
                qualityChart.innerHTML = `
                    <div class="chart-bar">
                        <div class="chart-label">Good</div>
                        <div class="chart-bar-bg">
                            <div class="chart-bar-fill" style="width: ${(stats.qualityDistribution.GOOD / total) * 100}%; background: var(--success-color);">
                                ${stats.qualityDistribution.GOOD}
                            </div>
                        </div>
                    </div>
                    <div class="chart-bar">
                        <div class="chart-label">Medium</div>
                        <div class="chart-bar-bg">
                            <div class="chart-bar-fill" style="width: ${(stats.qualityDistribution.MEDIUM / total) * 100}%; background: var(--warning-color);">
                                ${stats.qualityDistribution.MEDIUM}
                            </div>
                        </div>
                    </div>
                    <div class="chart-bar">
                        <div class="chart-label">Poor</div>
                        <div class="chart-bar-bg">
                            <div class="chart-bar-fill" style="width: ${(stats.qualityDistribution.POOR / total) * 100}%; background: var(--danger-color);">
                                ${stats.qualityDistribution.POOR}
                            </div>
                        </div>
                    </div>
                `;

                // Task Chart
                const taskChart = document.getElementById('taskChart');
                const maxCount = Math.max(...Object.values(stats.taskDistribution), 1);
                taskChart.innerHTML = Object.entries(stats.taskDistribution).map(([task, count]) => `
                    <div class="chart-bar">
                        <div class="chart-label">${task}</div>
                        <div class="chart-bar-bg">
                            <div class="chart-bar-fill" style="width: ${(count / maxCount) * 100}%;">
                                ${count}
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // User Management Functions

        // Show/hide users tab based on role
        function checkAdminAccess() {
            const user = getCurrentUser();
            if (user && user.role === 'admin') {
                document.getElementById('usersTab').style.display = 'block';
            }
        }

        // Load users list
        async function loadUsers() {
            try {
                const response = await authFetch(`${API_URL}/users`);
                const users = await response.json();

                const usersList = document.getElementById('usersList');
                if (users.length === 0) {
                    usersList.innerHTML = `<p style="color: var(--text-secondary); text-align: center;">${t('users.noUsers')}</p>`;
                    return;
                }

                usersList.innerHTML = users.map(user => `
                    <div style="display: flex; justify-content: space-between; align-items: center;
                                padding: 16px; margin-bottom: 12px; background: var(--light); border-radius: 8px;">
                        <div>
                            <div style="font-weight: 600;">${user.name}</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">
                                @${user.username} ‚Ä¢ ${user.role === 'admin' ? 'üëë ' + t('users.admin') : 'üë§ ' + t('users.staff')}
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                ${t('users.created')}: ${new Date(user.createdAt).toLocaleDateString()}
                            </div>
                        </div>
                        ${user.username !== 'wisag' ? `
                            <button onclick="deleteUser('${user.username}')"
                                    class="btn btn-secondary"
                                    style="width: auto; padding: 8px 16px; background: var(--danger-color); color: white; border: none;">
                                üóëÔ∏è ${t('users.delete')}
                            </button>
                        ` : ''}
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading users:', error);
                showToast(`‚ùå ${t('messages.failedToLoadUsers')}`, 'error');
            }
        }

        // Create new user
        async function createUser(event) {
            event.preventDefault();

            const username = document.getElementById('newUsername').value;
            const name = document.getElementById('newName').value;
            const password = document.getElementById('newPassword').value;

            try {
                const response = await authFetch(`${API_URL}/users`, {
                    method: 'POST',
                    body: { username, name, password, role: 'staff' }
                });

                const data = await response.json();

                if (response.ok) {
                    showToast(`‚úÖ ${t('messages.userCreated')}`, 'success');
                    document.getElementById('newUsername').value = '';
                    document.getElementById('newName').value = '';
                    document.getElementById('newPassword').value = '';
                    await loadUsers();
                } else {
                    showToast(`‚ùå ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Error creating user:', error);
                showToast(`‚ùå ${t('messages.failedToCreateUser')}`, 'error');
            }
        }

        // Delete user
        async function deleteUser(username) {
            if (!confirm(`${t('users.deleteConfirm')} "${username}"?`)) {
                return;
            }

            try {
                const response = await authFetch(`${API_URL}/users/${username}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    showToast(`‚úÖ ${t('messages.userDeleted')}`, 'success');
                    await loadUsers();
                } else {
                    showToast(`‚ùå ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showToast(`‚ùå ${t('messages.failedToDeleteUser')}`, 'error');
            }
        }

        // Edit Score Modal Functions
        let currentEditingInspectionId = null;

        function openEditScoreModal(inspectionId, currentScore) {
            currentEditingInspectionId = inspectionId;
            document.getElementById('newScoreInput').value = currentScore;
            const modal = document.getElementById('editScoreModal');
            modal.style.display = 'flex';
        }

        function closeEditScoreModal() {
            const modal = document.getElementById('editScoreModal');
            modal.style.display = 'none';
            currentEditingInspectionId = null;
        }

        async function updateScore() {
            const newScore = parseInt(document.getElementById('newScoreInput').value);

            if (!currentEditingInspectionId) {
                showToast('‚ùå No inspection selected', 'error');
                return;
            }

            if (isNaN(newScore) || newScore < 0 || newScore > 100) {
                showToast('‚ùå Score must be between 0 and 100', 'error');
                return;
            }

            try {
                const response = await authFetch(`${API_URL}/history/${currentEditingInspectionId}/score`, {
                    method: 'PUT',
                    body: { overallScore: newScore }
                });

                const data = await response.json();

                if (response.ok) {
                    showToast(`‚úÖ ${t('history.scoreUpdated')}`, 'success');
                    closeEditScoreModal();
                    await loadHistory();
                    await loadStats();
                } else {
                    showToast(`‚ùå ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Error updating score:', error);
                showToast('‚ùå Failed to update score', 'error');
            }
        }

        // Description Editing
        let currentEditingDescriptionId = null;
        function openEditDescription(inspectionId, evt) {
            currentEditingDescriptionId = inspectionId;
            const summaryEl = document.getElementById(`summary-${inspectionId}`);
            if (!summaryEl) return;
            const textEl = summaryEl.querySelector('.description-text');
            const existing = (textEl ? textEl.textContent : summaryEl.textContent).trim();
            summaryEl.innerHTML = `
                <textarea id="descEditArea" style="width:100%; padding:8px; font-size:13px; border:1px solid var(--border-color); border-radius:6px; resize:vertical; min-height:70px;">${existing.replace(/"/g,'&quot;')}</textarea>
                <div style="display:flex; gap:8px; margin-top:8px;">
                    <button class="btn btn-success" style="width:auto; padding:8px 16px;" onclick="saveDescription()">üíæ Save</button>
                    <button class="btn btn-secondary" style="width:auto; padding:8px 16px;" onclick="cancelDescriptionEdit()">‚úñ Cancel</button>
                </div>
            `;
        }

        async function saveDescription() {
            if (!currentEditingDescriptionId) return;
            const textarea = document.getElementById('descEditArea');
            if (!textarea) return;
            const newText = textarea.value.trim();
            if (!newText) {
                showToast('‚ùå Description cannot be empty', 'error');
                return;
            }
            try {
                const response = await authFetch(`${API_URL}/history/${currentEditingDescriptionId}/description`, {
                    method: 'PUT',
                    body: { summary: newText }
                });
                const data = await response.json();
                if (response.ok) {
                    showToast('‚úÖ Description updated', 'success');
                    const summaryEl = document.getElementById(`summary-${currentEditingDescriptionId}`);
                    if (summaryEl) {
                        // Re-render summary with edit button preserved
                        summaryEl.innerHTML = `<span class="description-text" style="flex:1;">${escapeHtml(newText)}</span>` +
                            (getCurrentUser()?.role === 'admin'
                                ? `<button onclick="openEditDescription('${currentEditingDescriptionId}', event)" class="inline-edit-btn" title="Edit description">üìù</button>`
                                : '');
                    }
                    currentEditingDescriptionId = null;
                } else {
                    showToast(`‚ùå ${data.error || 'Failed to update description'}`, 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('‚ùå Network error updating description', 'error');
            }
        }

        // Simple HTML escape for user-entered description
        function escapeHtml(str) {
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function cancelDescriptionEdit() {
            if (!currentEditingDescriptionId) return;
            // Reload just the history item by re-calling loadHistory (simple approach)
            loadHistory();
            currentEditingDescriptionId = null;
        }

        // Switch Tab
        function switchTab(tabName, event) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add active class to clicked tab
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            } else {
                // Fallback: find the button by onclick attribute
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    if (tab.onclick && tab.onclick.toString().includes(`'${tabName}'`)) {
                        tab.classList.add('active');
                    }
                });
            }

            document.getElementById(`tab-${tabName}`).classList.add('active');

            if (tabName === 'dashboard') {
                loadStats();
            } else if (tabName === 'history') {
                loadHistory();
            } else if (tabName === 'users') {
                loadUsers();
            }
        }

        // Show Toast
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Format Date Time (MM/DD/YYYY-HH:MM)
        function formatDateTime(date) {
            const d = new Date(date);
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const year = d.getFullYear();
            const hours = String(d.getHours()).padStart(2, '0');
            const minutes = String(d.getMinutes()).padStart(2, '0');

            return `${month}/${day}/${year}-${hours}:${minutes}`;
        }

        // Language button management
        function updateLanguageButtons() {
            document.querySelectorAll('.lang-btn-small').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase() === currentLanguage) {
                    btn.classList.add('active');
                }
            });
        }

        // Override setLanguage to update buttons and refresh dynamic content
        const originalSetLanguage = setLanguage;
        setLanguage = function(lang) {
            originalSetLanguage(lang);
            updateLanguageButtons();
            // Refresh dynamic content
            loadHistory();
            loadStats();
            if (document.getElementById('tab-users').classList.contains('active')) {
                loadUsers();
            }
        };

        // Initialize language on load
        updateLanguageButtons();

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopCamera();
        });
    </script>
</body>
</html>
